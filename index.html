<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Boss Countdown ‚Ä¢ Auto Sync + Per-Boss Mute (UTC+7)</title>

<link id="app-favicon" rel="icon" type="image/x-icon" href="">
<script>
  // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ favicon ‡∏ä‡∏µ‡πâ‡∏ñ‡∏π‡∏Å path ‡πÅ‡∏°‡πâ‡∏£‡∏±‡∏ô‡πÉ‡∏ô subfolder
  function asset(p){ const base = location.pathname.replace(/\/[^/]*$/, '/'); return base + p; }
  document.addEventListener('DOMContentLoaded',()=>{
    const fav=document.getElementById('app-favicon');
    if(fav) fav.href=asset('favicon.ico');
  });
</script>

<style>
  :root{--bg:#0b0f14;--card:#111823;--text:#d7e2f2;--muted:#99a6b6;--warn:#f1c40f;--hot:#ff6b6b;--blue:#254f85;--blue-2:#24374f;--accent:#4785ff}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--bg);color:var(--text)}
  header{background:#0e1d2e;border-bottom:1px solid #24374f;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;padding:14px 24px;border-radius:0 0 12px 12px}
  .clockWrap{display:flex;flex-direction:column;gap:2px}
  .now{font-size:28px;font-weight:800;color:#fff}
  .tz{color:#b5b5b5;font-size:13px}
  .controls.bar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:flex-end}
  .control{display:flex;align-items:center;gap:10px;background:var(--blue);border:1px solid var(--blue-2);border-radius:10px;padding:8px 12px;color:#fff}
  .control-title{font-size:13px;font-weight:600}
  .control.switch{position:relative;gap:10px;cursor:pointer}
  .control.switch input{position:absolute;inset:0;opacity:0}
  .switch-ui{width:46px;height:26px;border-radius:999px;background:#1b2838;border:1px solid #1b2838;position:relative;transition:.18s}
  .switch-ui::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.18s;box-shadow:0 1px 2px rgba(0,0,0,.35)}
  .control.switch input:checked + .switch-ui{background:var(--accent);border-color:#4078e6}
  .control.switch input:checked + .switch-ui::after{transform:translateX(20px)}
  .control.volume{min-width:260px}
  .control.volume input[type=range]{accent-color:var(--accent);width:160px;height:6px}
  #volVal{min-width:38px;text-align:right;font-variant-numeric:tabular-nums}

  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .pane{background:#0e1621;border:1px solid #1c2430;border-radius:12px;padding:12px;margin-bottom:14px}
  .hint{color:var(--muted);font-size:12px}
  .statusMsg{color:#9fb3ca;font-size:12px;margin-top:6px}

  .dayhead{margin:20px 0 8px;color:#dfe8f7;font-weight:800;letter-spacing:.2px}
  .cols{display:grid;grid-template-columns:2fr 110px 140px 170px 120px;gap:8px;align-items:center}
  .head{color:#8aa0b8;font-weight:700;padding:8px 12px}
  .row{background:var(--card);border:1px solid #1c2430;border-radius:10px;padding:12px;margin-bottom:10px}
  .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .time{font-weight:700}
  .due{font-variant-numeric:tabular-nums}
  .pill{display:inline-block;padding:.2rem .55rem;border-radius:999px;font-size:12px;border:1px solid #223044;color:#8aa0b8}
  .soon{color:var(--warn);border-color:#544a13}
  .hot{color:#fff;background:var(--hot);border-color:transparent}
  .past{opacity:.4}
  .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;border-radius:999px;padding:.35rem .7rem;background:#121b28;border:1px solid #223044;color:#cfd9e7;cursor:pointer}
  .chip:hover{border-color:#3a536e}
  .chip.muted{background:#1a2230;color:#9fb0c9;border-color:#33495f}

  @media (max-width:720px){
    header{padding:12px 14px;gap:10px}.now{font-size:22px}.tz{font-size:12px}
    .controls.bar{width:100%;justify-content:flex-start}
    .control.volume{min-width:unset;flex:1}.control.volume input[type=range]{width:100%}
    .wrap{padding:12px}.head{display:none}
    .row.cols{
      display:grid;
      grid-template-columns: 1fr auto;
      grid-template-areas:
        "name  alert"
        "time  alert"
        "due   alert"
        "status alert";
      row-gap:6px;align-items:start
    }
    .name{grid-area:name;font-size:16px;font-weight:700;line-height:1.25}
    .alertCell{grid-area:alert;display:flex;justify-content:flex-end;align-self:center}
    .time{grid-area:time;display:block;font-size:13px;color:#cbd5e1}
    .time::before{content:"Time ";color:#8aa0b8;font-weight:700;margin-right:4px}
    .due{grid-area:due;display:block;font-size:13px;color:#cbd5e1}
    .due::before{content:"Left ";color:#8aa0b8;font-weight:700;margin-right:6px}
    .statusCell{grid-area:status;display:block}
    .statusCell .pill{font-size:12px;padding:.18rem .5rem}
    .chip{padding:.4rem .8rem;font-size:13px}
  }

  /* overlay ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
  #soundGate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);z-index:9999}
  #soundGateCard{background:#121b28;border:1px solid #223044;border-radius:14px;padding:18px;max-width:520px;width:92%;color:#d7e2f2;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .btn{background:#152233;color:#fff;border:1px solid #213246;border-radius:10px;padding:10px 12px;cursor:pointer}
</style>
</head>

<body>
<header>
  <div class="clockWrap">
    <div class="now" id="now">--:--:--</div>
    <div class="tz">Asia/Bangkok ‚Ä¢ (UTC+7)</div>
  </div>
  <div class="controls bar">
    <label class="control switch">
      <input id="soundToggle" type="checkbox" checked>
      <span class="switch-ui"></span>
      <span class="control-title">Enable sound</span>
    </label>
    <div class="control volume">
      <span class="control-title">Volume</span>
      <input id="vol" type="range" min="0" max="100" step="1"><span id="volVal">80%</span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="pane">
    <div class="hint">Auto-sync from Google Sheet</div>
    <div id="syncStatus" class="statusMsg">Syncing automatically‚Ä¶</div>
  </div>

  <div class="cols head">
    <div>Boss</div><div>Time</div><div>Countdown</div><div>Status</div><div>Alert</div>
  </div>
  <div id="list"></div>
</div>

<footer style="color:#7f8ea3;text-align:center;padding:12px 0 26px">
  Lord Nine Boss Alert V1.3
</footer>

<!-- overlay ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á -->
<div id="soundGate" style="display:none">
  <div id="soundGateCard">
    <h3>Enable Sound</h3>
    <p>Tap ‚ÄúEnable‚Äù once so your browser allows audio alerts (required on mobile).</p>
    <div class="actions">
      <button id="btnTest" class="btn">Test Sound</button>
      <button id="btnEnable" class="btn">Enable</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const SHEET_ID   = "1i0IWDnKauf7hT792nsWrFBWNepWBtJq6IStUiF2LGAs";
const SHEET_NAME = "BossAlert";
const RANGE_A1   = "U4";
const SYNC_MS    = 20000;

/* ====== TIME (UTC+7) ====== */
const TZ="Asia/Bangkok";
const BKK_OFFSET_MS = 7*60*60*1000;
function fmtNow(){return new Date().toLocaleTimeString('en-GB',{hour12:false,timeZone:TZ});}
function fmtHMS(ms){if(ms<0)ms=0;const s=Math.floor(ms/1000);const hh=String(Math.floor(s/3600)).padStart(2,"0");const mm=String(Math.floor((s%3600)/60)).padStart(2,"0");const ss=String(s%60).padStart(2,"0");return `${hh}:${mm}:${ss}`;}
function atOn(dateStr,hhmm){const[y,m,d]=dateStr.split('-').map(Number);const[h,mi]=hhmm.split(':').map(Number);return new Date(Date.UTC(y,m-1,d,h,mi,0,0)-BKK_OFFSET_MS);}

/* ====== STATE ====== */
let sections=[];        // [{dateStr,label,items:[{name,at}],rows:[]}]
let alertedState={};    // reset on new sheet text
let lastRaw="";

/* ====== DOM ====== */
const nowEl=document.getElementById('now');
const listEl=document.getElementById('list');
const syncStatus=document.getElementById('syncStatus');
const volSlider=document.getElementById('vol');
const volVal=document.getElementById('volVal');
const soundToggle=document.getElementById('soundToggle');
const soundGate=document.getElementById('soundGate');
const btnEnable=document.getElementById('btnEnable');
const btnTest=document.getElementById('btnTest');

/* ====== SOUND (WebAudio) ====== */
let audioEnabled=true;      // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå
let audioCtx=null, gainNode=null;
let buffers={ m5:null, hit:null };

function getVolume(){ return Math.max(0, Math.min(1, (Number(localStorage.getItem("bossVol")||80)/100))); }
function setVolume(v){ if(gainNode) gainNode.gain.value=v; localStorage.setItem('bossVol',Math.round(v*100)); volVal.textContent=`${Math.round(v*100)}%`; }

async function ensureAudioCtx(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    gainNode=audioCtx.createGain();
    gainNode.gain.value=getVolume();
    gainNode.connect(audioCtx.destination);
  }
  if(audioCtx.state==='suspended'){ try{ await audioCtx.resume(); }catch{} }
  return audioCtx.state==='running';
}
async function fetchDecode(url){ const res=await fetch(url,{cache:'force-cache'}); const ab=await res.arrayBuffer(); return await audioCtx.decodeAudioData(ab); }
async function loadAudioBuffers(){
  const ok=await ensureAudioCtx(); if(!ok) return false;
  try{
    const [b1,b2]=await Promise.all([
      fetchDecode('sounds/5min.mp3'),
      fetchDecode('sounds/hit.mp3')
    ]);
    buffers.m5=b1; buffers.hit=b2; return true;
  }catch(e){ console.warn('Decode audio failed:', e); return false; }
}
function showGate(){ soundGate.style.display='flex'; }
function hideGate(){ soundGate.style.display='none'; }

// ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏≠‡∏á‡∏ï‡∏≠‡∏ô Enable)
async function playBuffer(type){
  if(!audioEnabled) return;
  const ok=await ensureAudioCtx();
  if(!ok){ showGate(); return; }
  if(!buffers[type]){
    const loaded=await loadAudioBuffers();
    if(!loaded) return;
  }
  try{
    const src=audioCtx.createBufferSource();
    src.buffer = buffers[type];
    src.connect(gainNode);
    src.start(0);
  }catch(e){
    console.warn('playBuffer failed:', e);
    showGate();
  }
}
function playCue(kind){ return playBuffer(kind==='m5'?'m5':'hit'); }

/* ====== Buttons (‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ô Enable) ====== */
btnEnable.addEventListener('click', async ()=>{
  // ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á & ‡πÇ‡∏´‡∏•‡∏î buffer ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å ‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  const ok = await ensureAudioCtx();
  if(ok){ await loadAudioBuffers(); hideGate(); }
});
btnTest.addEventListener('click', async ()=>{
  const ok = await ensureAudioCtx();
  if(ok){ if(!buffers.m5) await loadAudioBuffers(); playBuffer('m5'); }
  else showGate();
});

/* ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ foreground ‡πÉ‡∏´‡πâ resume ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
document.addEventListener('visibilitychange', async ()=>{
  if(document.visibilityState==='visible' && audioCtx && audioCtx.state==='suspended'){
    try{ await audioCtx.resume(); }catch{}
  }
});

/* ====== PARSER (day header + items) ====== */
const DAY_RE=/^(?:["'`‚Äú‚Äù‚Äò‚Äô]\s*)?(?:[\u{1F550}-\u{1F567}\u23F0\u23F3]\s*)?(Mon|Tue|Wed|Thu|Fri|Sat|Sun)\s+(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s*["'`‚Äú‚Äù‚Äò‚Äô])?$/iu;
function stripLineQuotes(s){return s.replace(/^[\s"'‚Äú‚Äù‚Äò‚Äô`]+/,"").replace(/[\s"'‚Äú‚Äù‚Äò‚Äô`]+$/,"")}
function parseSchedule(text){
  let cleaned=String(text).trim().replace(/^[\s"'‚Äú‚Äù‚Äò‚Äô`]+/,"").replace(/[\s"'‚Äú‚Äù‚Äò‚Äô`]+$/,"");
  const lines=cleaned.split(/\r?\n/).map(l=>stripLineQuotes(l.trim())).filter(Boolean);
  const out=[]; let cur=null; let sawHeader=false;
  for(const line of lines){
    const d=line.match(DAY_RE);
    if(d){
      sawHeader=true;
      const[,dow,dd,MM,YYYY]=d;
      const dd2=String(+dd).padStart(2,'0'), MM2=String(+MM).padStart(2,'0');
      const dateStr=`${YYYY}-${MM2}-${dd2}`;
      cur={dateStr,label:`${dow} ${dd2}/${MM2}/${YYYY}`,items:[],rows:[]};
      out.push(cur); continue;
    }
    const m=line.match(/(\d{1,2}):(\d{2})\s*$/);
    if(!m) continue;
    if(!cur) throw new Error('Please add a day header first (e.g. "üïê Tue 28/10/2025").');
    const at=`${String(+m[1]).padStart(2,'0')}:${String(+m[2]).padStart(2,'0')}`;
    const name=line.slice(0,line.lastIndexOf(m[0])).replace(/\s*\[.*?\]\s*$/,'').trim();
    cur.items.push({name,at});
  }
  if(!sawHeader) throw new Error('No day headers found. Start with: "üïê Tue 28/10/2025"');
  return out;
}

/* ====== UI ====== */
function buildUI(){
  listEl.innerHTML='';
  sections.forEach(sec=>{
    const h=document.createElement('div'); h.className='dayhead'; h.textContent=`üïê ${sec.label}`; listEl.appendChild(h);
    sec.rows=[];
    sec.items.forEach(item=>{
      const row=document.createElement('div'); row.className='row cols';
      const nameEl=document.createElement('div'); nameEl.className='name';
      const timeEl=document.createElement('div'); timeEl.className='time';
      const dueEl=document.createElement('div'); dueEl.className='due';
      const statusCell=document.createElement('div'); statusCell.className='statusCell';
      const badge=document.createElement('span'); badge.className='pill'; badge.textContent='Waiting';
      statusCell.appendChild(badge);
      const alertCell=document.createElement('div'); alertCell.className='alertCell';
      const muteBtn=document.createElement('button'); muteBtn.className='chip'; muteBtn.textContent='üîî Alert';
      alertCell.appendChild(muteBtn);
      row.append(nameEl,timeEl,dueEl,statusCell,alertCell); listEl.appendChild(row);

      const r={nameEl,timeEl,dueEl,badgeEl:badge,muteBtn,rowEl:row,muted:false};
      muteBtn.addEventListener('click',()=>{ r.muted=!r.muted; muteBtn.classList.toggle('muted', r.muted); muteBtn.textContent = r.muted?'üîï Muted':'üîî Alert'; });
      sec.rows.push(r);
    });
  });
}

/* ====== TICK (‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) ====== */
function updateTick(){
  nowEl.textContent = fmtNow();
  const nowMs = Date.now();

  sections.forEach((sec)=>{
    sec.items.forEach((b, i)=>{
      const r = sec.rows[i]; if(!r) return;
      const ms = atOn(sec.dateStr, b.at).getTime() - nowMs;

      r.nameEl.textContent = b.name;
      r.timeEl.textContent = b.at;
      r.dueEl.textContent  = fmtHMS(ms);
      r.rowEl.classList.toggle('past', ms < 0);

      r.badgeEl.className = 'pill';
      if (ms <= 0 && ms > -60_000){
        r.badgeEl.classList.add('hot'); r.badgeEl.textContent = "It's time!";
      } else if (ms <= 60_000 && ms > 0){
        r.badgeEl.classList.add('soon'); r.badgeEl.textContent = "Less than 1 min";
      } else if (ms <= 5*60_000 && ms > 60_000){
        r.badgeEl.classList.add('soon'); r.badgeEl.textContent = "Within 5 min";
      } else {
        r.badgeEl.textContent = "Waiting";
      }
    });
  });
}

/* ====== Alerts engine (one-shot) ====== */
function resetAlertFlags(){ alertedState = {}; }
function markAndShouldFire(key, tag){
  if(!alertedState[key]) alertedState[key]={};
  if(alertedState[key][tag]) return false;
  alertedState[key][tag]=true; return true;
}
function alertTick(){
  const nowMs = Date.now();
  sections.forEach((sec)=>{
    sec.items.forEach((b,i)=>{
      const r=sec.rows[i]; if(!r || r.muted) return;
      const key = `${sec.dateStr}|${b.at}|${b.name}`;
      const ms  = atOn(sec.dateStr, b.at).getTime() - nowMs;

      if (ms <= 5*60_000 && ms > 60_000){
        if (markAndShouldFire(key,'m5')) playCue('m5');
      }
      if (ms <= 0 && ms > -1000){
        if (markAndShouldFire(key,'hit')) playCue('hit');
      }
    });
  });
}

/* ====== Google Sheet via GViz JSONP ====== */
function buildGVizUrl(cb){
  const base=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
  const qs=new URLSearchParams({tqx:`out:json;responseHandler:${cb}`,sheet:SHEET_NAME,range:RANGE_A1,headers:"0"});
  return `${base}?${qs.toString()}`;
}
function jsonp(url,cb,timeout=12000){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script'); let done=false;
    const timer=setTimeout(()=>{cleanup();reject(new Error('JSONP timeout'))},timeout);
    function cleanup(){ if(done) return; done=true; clearTimeout(timer); delete window[cb]; s.remove(); }
    window[cb]=data=>{ cleanup(); resolve(data); };
    s.onerror=()=>{ cleanup(); reject(new Error('JSONP network error')); };
    s.src=url; document.head.appendChild(s);
  });
}
function extractU4(resp){
  if(!resp?.table?.rows?.length) throw new Error('No data in BossAlert!U4');
  const cell = resp.table.rows[0].c?.[0];
  return String(cell?.v ?? cell?.f ?? '').trim();
}
async function syncFromSheet(){
  try{
    const cb="cb_"+Math.random().toString(36).slice(2);
    const payload=await jsonp(buildGVizUrl(cb),cb);
    const raw=extractU4(payload);
    if(raw && raw!==lastRaw){
      lastRaw=raw;
      resetAlertFlags();
      sections=parseSchedule(raw);
      buildUI();
      updateTick();
    }
    syncStatus.textContent=`Last synced at ${new Date().toLocaleTimeString('en-GB',{hour12:false,timeZone:TZ})}`;
  }catch(e){
    console.warn(e);
    syncStatus.textContent=`Sync error: ${e.message}`;
  }
}

/* ====== INIT ====== */
(function init(){
  // persist sound toggle
  const savedSound=localStorage.getItem('bossSound');
  audioEnabled = savedSound!==null ? (savedSound==='true') : true;
  soundToggle.checked=audioEnabled;
  soundToggle.addEventListener('change',e=>{
    audioEnabled=e.target.checked;
    localStorage.setItem('bossSound', String(audioEnabled));
    // ‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏¥‡∏î overlay ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î Enable/ Test ‡πÄ‡∏≠‡∏á ‚Äî ‡πÑ‡∏°‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    if(audioEnabled) showGate();
  });

  // persist volume
  const savedVol=Number(localStorage.getItem('bossVol'));
  const vol=Number.isFinite(savedVol)?savedVol:80;
  volSlider.value=String(vol); volVal.textContent=`${vol}%`;
  volSlider.addEventListener('input',e=>setVolume(Number(e.target.value)/100));

  if(audioEnabled) showGate();

  updateTick(); setInterval(updateTick,1000);
  setInterval(alertTick, 500);     // ‡∏ï‡∏£‡∏ß‡∏à trigger ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  syncFromSheet(); setInterval(syncFromSheet, SYNC_MS);
})();
</script>
</body>
</html>
